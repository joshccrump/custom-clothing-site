# 1) Replace package.json with a clean, valid config
cat > package.json <<'JSON'
{
  "name": "custom-clothing-site",
  "private": true,
  "type": "module",
  "scripts": {
    "sync:square": "node scripts/fetch-square.mjs"
  },
  "engines": { "node": ">=20 <23" },
  "dependencies": {
    "square": "^40.0.0"
  }
}
JSON

# 2) Add the ESM Square sync (works on Node 20+)
mkdir -p scripts data
cat > scripts/fetch-square.mjs <<'JS'
import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";
import { Client, Environment } from "square";

const ACCESS_TOKEN = process.env.SQUARE_ACCESS_TOKEN;
const LOCATION_ID  = process.env.SQUARE_LOCATION_ID || "";
// Accept either SQUARE_ENV or SQUARE_ENVIRONMENT
const RAW_ENV      = (process.env.SQUARE_ENV || process.env.SQUARE_ENVIRONMENT || "production").toLowerCase();

if (!ACCESS_TOKEN || !LOCATION_ID) {
  console.error("Missing SQUARE_ACCESS_TOKEN or SQUARE_LOCATION_ID env vars.");
  process.exit(1);
}

const envMap = { production: Environment.Production, sandbox: Environment.Sandbox };
const client = new Client({
  accessToken: ACCESS_TOKEN,
  environment: envMap[RAW_ENV] ?? Environment.Production,
});

const __filename = fileURLToPath(import.meta.url);
const __dirname  = path.dirname(__filename);
const OUT_FILE   = path.resolve(__dirname, "..", process.env.OUTPUT_PATH || "data/products.json");

function moneyToNumber(m) {
  return m && typeof m.amount === "number" ? m.amount / 100 : null;
}

async function fetchAllCatalog(types = ["ITEM", "ITEM_VARIATION", "IMAGE"]) {
  const out = [];
  let cursor;
  do {
    const resp = await client.catalogApi.listCatalog({ cursor, types: types.join(",") });
    if (resp.result?.objects) out.push(...resp.result.objects);
    cursor = resp.result?.cursor;
  } while (cursor);
  return out;
}

const indexById = (objs) => new Map(objs.map(o => [o.id, o]));

function buildProducts(objects) {
  const byId = indexById(objects);
  const items = objects.filter(o => o.type === "ITEM");

  const products = items.map(item => {
    const d = item.itemData || {};
    const imageIds = new Set([...(d.imageIds || [])]);

    const variations = (d.variations || []).map(v => {
      const vd = v.itemVariationData || {};
      if (vd.imageIds) vd.imageIds.forEach(id => imageIds.add(id));
      return {
        id: v.id,
        name: vd.name || "Default",
        sku: vd.sku || null,
        price: moneyToNumber(vd.priceMoney),
        inventory: null
      };
    }).sort((a,b) => String(a.name).localeCompare(String(b.name)));

    const images = [...imageIds]
      .map(id => byId.get(id))
      .filter(Boolean)
      .map(img => img.imageData?.url)
      .filter(Boolean);

    const modifiers = (d.modifierListInfo || []).map(m => ({
      id: m.modifierListId,
      enabled: m.enabled ?? true
    }));

    const priceFrom = variations.reduce((min, v) => (v.price != null && v.price < min ? v.price : min), Infinity);

    return {
      id: item.id,
      name: d.name,
      description: d.descriptionPlaintext || d.description || "",
      category: d.categoryId || null,
      images,
      variations,
      modifiers,
      priceFrom: Number.isFinite(priceFrom) ? priceFrom : null,
      squareUrl: null,
      updatedAt: item.updatedAt
    };
  });

  return products;
}

async function main() {
  console.log("Fetching Square catalog…");
  const objects = await fetchAllCatalog();
  const products = buildProducts(objects);

  await fs.mkdir(path.dirname(OUT_FILE), { recursive: true });
  const payload = {
    locationId: LOCATION_ID,
    env: RAW_ENV,
    products
  };
  await fs.writeFile(OUT_FILE, JSON.stringify(payload, null, 2));
  console.log(`Wrote ${products.length} products → ${path.relative(process.cwd(), OUT_FILE)}`);
}

main().catch(err => {
  console.error("Sync failed:", err);
  process.exit(1);
});
JS

# 3) Install deps and test
npm i
SQUARE_ACCESS_TOKEN="***" \
SQUARE_LOCATION_ID="YOUR_LOCATION_ID" \
SQUARE_ENVIRONMENT="production" \
OUTPUT_PATH="data/products.json" \
npm run sync:square

# 4) Commit
git add package.json package-lock.json scripts/fetch-square.mjs data/products.json
git commit -m "Fix Square sync: clean package.json, add ESM fetch script"
git push
