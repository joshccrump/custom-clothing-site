name: Square Sync

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run without committing changes"
        required: false
        default: "false"
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours

permissions:
  contents: write

concurrency:
  group: square-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      SQUARE_ACCESS_TOKEN: ${{ secrets.SQUARE_ACCESS_TOKEN }}
      SQUARE_ENVIRONMENT: ${{ vars.SQUARE_ENVIRONMENT || 'production' }}
      SQUARE_LOCATION_ID: ${{ vars.SQUARE_LOCATION_ID }}
      OUTPUT_PATH: data/square-items.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Ensure Node project & install Square SDK
        run: |
          # Create package.json if the repo doesn't have one
          if [ ! -f package.json ]; then
            npm init -y
          fi
          # Ensure ESM so .mjs / import works cleanly
          npm pkg set type=module
          # Install/upgrade Square SDK (works for both new and legacy imports via square/legacy)
          npm install square@^40

      - name: Install deps (if the repo already had a package.json/lock)
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi

      - name: Verify script and npm scripts
        working-directory: ${{ steps.workdir.outputs.dir }}
        run: |
          if [ ! -f scripts/fetch-square.js ] && [ ! -f scripts/fetch-square.mjs ] && [ ! -f scripts/fetch-square.cjs ]; then
            echo "::error::Missing Square sync script (scripts/fetch-square.js|mjs|cjs)"
            exit 1
          fi
          node --input-type=module -e "import { readFileSync } from 'fs'; const pkg = JSON.parse(readFileSync(new URL('./package.json', import.meta.url))); if (!pkg?.scripts?.['sync:square']) { console.error('::error::package.json is missing a \\'sync:square\\' npm script'); process.exit(1); } console.log('package name:', pkg.name); console.log('has script sync:square:', true);"

      - name: Run sync
        working-directory: ${{ steps.workdir.outputs.dir }}
        env:
          SQUARE_ACCESS_TOKEN: ${{ secrets.SQUARE_ACCESS_TOKEN }}
          SQUARE_ENV: ${{ secrets.SQUARE_ENV || 'production' }}
          SQUARE_LOCATION_ID: ${{ secrets.SQUARE_LOCATION_ID }}
        run: |
          npm run sync:square

            - name: Run Square fetch script (REST)
              run: | 
              node scripts/fetch-square.mjs --out "${OUTPUT_PATH}"


      - name: Show diff
        run: |
          if git diff --quiet -- "${OUTPUT_PATH}"; then
            echo "No changes in ${OUTPUT_PATH}"
          else
            echo "Detected changes in ${OUTPUT_PATH}"
            git --no-pager diff -- "${OUTPUT_PATH}" | tail -n +1 | sed -n '1,120p'
          fi

      - name: Commit & push changes (unless dry run)
        if: ${{ inputs.dry_run != 'true' }}
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "chore(square): sync items from Square API"
          branch: ${{ github.ref_name }}
          file_pattern: ${{ env.OUTPUT_PATH }}

      - name: Dry run note
        if: ${{ inputs.dry_run == 'true' }}
        run: echo "Dry run selected â€” not committing changes."
