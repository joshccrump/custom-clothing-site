async function j(u){const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error('failed '+u);return await r.json()}function f(n,c='USD'){try{return new Intl.NumberFormat(undefined,{style:'currency',currency:c}).format(n)}catch{return '$'+Number(n).toFixed(2)}}function u(a){return[...new Set(a.filter(Boolean))]}function pg(list,p,per){const pages=Math.max(1,Math.ceil(list.length/per));const P=Math.min(Math.max(1,p),pages);return{page:P,pages,items:list.slice((P-1)*per,(P-1)*per+per)}}function fl(ps,s){const q=(s.q||'').toLowerCase().trim();const cat=(s.category||'').toLowerCase();const size=(s.size||'').toLowerCase();let out=ps.filter(p=>{if(p.status&&p.status.toLowerCase()==='hidden')return false;const textOk=q?([p.title,p.description,p.category,...(p.tags||[]),...(p.sizes||[]),...(p.colors||[])].join(' ').toLowerCase().includes(q)):true;const catOk=cat?((p.category||'').toLowerCase()===cat):true;const sizeOk=size?((p.sizes||[]).map(s=>String(s).toLowerCase()).includes(size)):true;return textOk&&catOk&&sizeOk});if(s.sort==='price-asc')out.sort((a,b)=>(a.price||0)-(b.price||0));else if(s.sort==='price-desc')out.sort((a,b)=>(b.price||0)-(a.price||0));else if(s.sort==='newest')out.sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0));return out}function renderGrid(c,items,curr){c.innerHTML='';if(!items.length){c.innerHTML='<div class="subtle">No items match your filters.</div>';return;}for(const p of items){const el=document.createElement('article');el.className='card';el.innerHTML=`<div class='card__media'><img class='card__img' alt='${p.title||'Product'}' src='${p.thumbnail||'../assets/default-product.svg'}'>${Number(p.stock)===0?'<span class="badge out">Out of stock</span>':''}${(p.tags||[]).includes('best-seller')?'<span class="badge">Best Seller</span>':''}</div><div class='card__body'><h3 class='title'>${p.title||'Untitled'}</h3><div class='price'>${typeof p.price==='number'?f(p.price,p.currency||curr):''}</div><div class='card__actions'>${p.url?`<a class='btn btn--buy' target='_blank' rel='noopener' href='${p.url}'>Buy</a>`:''}</div></div>`;c.appendChild(el)}}document.addEventListener('DOMContentLoaded',async function(){const s={q:'',category:'',size:'',sort:'featured',page:1,per:12};const grid=document.getElementById('grid');const pager=document.getElementById('pager');const searchEl=document.getElementById('search');const catEl=document.getElementById('category');const sizeEl=document.getElementById('size');const sortEl=document.getElementById('sort');let ps=[];let curr='USD';try{ps=await j('../data/products.json');const sample=ps.find(p=>p.currency);if(sample)curr=sample.currency}catch(e){grid.innerHTML='<div class="subtle">Could not load products (check <code>data/products.json</code> path).</div>';console.error(e);return;}const cats=u(ps.map(p=>p.category));catEl.innerHTML='<option value="">All categories</option>'+cats.map(c=>`<option>${c}</option>`).join('');const sizes=u(ps.flatMap(p=>p.sizes||[]));sizeEl.innerHTML='<option value="">Any size</option>'+sizes.map(v=>`<option>${v}</option>`).join('');function render(){const filtered=fl(ps,s);const {page,pages,items}=pg(filtered,s.page,s.per);renderGrid(grid,items,curr);pager.innerHTML='';const prev=document.createElement('button');prev.textContent='Prev';prev.disabled=(page<=1);prev.onclick=()=>{s.page=Math.max(1,page-1);render()};const info=document.createElement('span');info.style.padding='8px 6px';info.className='subtle';info.textContent=`Page ${page} of ${pages}`;const next=document.createElement('button');next.textContent='Next';next.disabled=(page>=pages);next.onclick=()=>{s.page=Math.min(pages,page+1);render()};pager.append(prev,info,next)}searchEl.oninput=()=>{s.q=searchEl.value.trim();s.page=1;render()};catEl.onchange=()=>{s.category=catEl.value.trim();s.page=1;render()};sizeEl.onchange=()=>{s.size=sizeEl.value.trim();s.page=1;render()};sortEl.onchange=()=>{s.sort=sortEl.value.trim();s.page=1;render()};render()});